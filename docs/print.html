<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>My IoT</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><a href="installation.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li><a href="recipes.html"><strong aria-hidden="true">3.</strong> Recipes</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">My IoT</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                            <a href="https://github.com/eigenein/my-iot" title="Git repository" aria-label="Git repository">
                                <i id="git-repository-button" class="fa fa-code-fork"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#introduction" id="introduction"><h1>Introduction</h1></a>
<a class="header" href="#what-is-it" id="what-is-it"><h2>What is it?</h2></a>
<p>This is yet another home automation that Iâ€™m building for myself as an open-source project.</p>
<a class="header" href="#features-and-goals" id="features-and-goals"><h2>Features and goals</h2></a>
<ul>
<li>As less configuration and customization as possible. It should just work without my close attention.</li>
<li>Automation is a normal Python module, you can code whatever you want.</li>
<li>Able to run on Raspberry Pi Zero (W).</li>
<li>Does not require a custom OS image to be flashed onto SD-card. The Docker image should just work on any normal OS distribution.</li>
<li>As less JavaScript as possible to speed up development.</li>
<li>Custom devices built with <a href="https://esphome.io/">ESPHome</a> should be supported.</li>
</ul>
<a class="header" href="#technology-stack" id="technology-stack"><h2>Technology stack</h2></a>
<ul>
<li>Python 3.x: backend</li>
<li><a href="https://aiohttp.readthedocs.io/">AIOHTTP</a>: HTTP server and client</li>
<li><a href="https://bulma.io/">Bulma</a>: frontend</li>
<li><a href="http://jinja.pocoo.org/">Jinja2</a>: template engine</li>
<li><a href="https://nginx.org/">Nginx</a>: reverse-proxy for authentication and HTTPS support</li>
<li><a href="https://www.docker.com/">Docker</a>: for production deployment</li>
</ul>
<a class="header" href="#how-it-looks-like" id="how-it-looks-like"><h2>How it looks like</h2></a>
<a class="header" href="#home" id="home"><h3>Home</h3></a>
<p><img src="index.png" alt="Home" /></p>
<a class="header" href="#services" id="services"><h3>Services</h3></a>
<p><img src="services.png" alt="Services" /></p>
<a class="header" href="#channel" id="channel"><h3>Channel</h3></a>
<p><img src="channel.png" alt="Channel" /></p>
<a class="header" href="#installation" id="installation"><h1>Installation</h1></a>
<p>My IoT is being developed as a normal Python package and thus could be run via the console entry point. This is what you would normally do to test it locally. But for production deployment it is recommended to use <a href="https://docs.docker.com/compose/">Docker Compose</a>. Then Docker becomes virtually the only pre-requisite.</p>
<a class="header" href="#https" id="https"><h2>HTTPS</h2></a>
<p>Set up <a href="https://letsencrypt.org/">Letâ€™s Encrypt</a>. That is out of scope for this tutorial.</p>
<a class="header" href="#nginxconf" id="nginxconf"><h2><code>nginx.conf</code></h2></a>
<p>Youâ€™ll need an Nginx reverse proxy configuration. Copy-paste the following one and put correct paths into <code>ssl_certificate</code> and <code>ssl_certificate_key</code>:</p>
<pre><code class="language-nginx">events { }

http {
    upstream backend {
        server 127.0.0.1:8080;
        keepalive 32;
    }

    server {
        listen 443 ssl default_server;
        listen [::]:443 default_server;
        charset utf-8;
        
        add_header Strict-Transport-Security max-age=2592000;
        
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_certificate /etc/letsencrypt/live/example.com/cert.pem;
        ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
        ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA';
        ssl_prefer_server_ciphers on;
        
        gzip on;
        gzip_buffers 16 8k;
        gzip_comp_level 6;
        gzip_http_version 1.1;
        gzip_min_length 256;
        gzip_proxied any;
        gzip_vary on;
        gzip_types
            text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml
            text/javascript application/javascript application/x-javascript
            text/x-json application/json application/x-web-app-manifest+json
            text/css text/plain text/x-component
            font/opentype application/x-font-ttf application/vnd.ms-fontobject
            image/x-icon;
        gzip_disable &quot;msie6&quot;;
        
        auth_basic &quot;My IoT&quot;;
        auth_basic_user_file /etc/nginx/.htpasswd;
        
        location / {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Connection &quot;&quot;;
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
</code></pre>
<a class="header" href="#htpasswd" id="htpasswd"><h2><code>.htpasswd</code></h2></a>
<p>Create credentials file for HTTP Basic Authentication for your username:</p>
<pre><code class="language-bash">sudo apt-get install apache2-utils
htpasswd -c .htpasswd [username]
</code></pre>
<a class="header" href="#automationpy" id="automationpy"><h2><code>automation.py</code></h2></a>
<p>Here lives your services configuration and automation. Start with the following <code>automation.py</code> file:</p>
<pre><code class="language-python"># TODO
</code></pre>
<p>Itâ€™s strictly advised to keep it under version control. <a href="https://github.com/">GitHub</a> allows you to have a private repo for free.</p>
<a class="header" href="#docker-composeyml" id="docker-composeyml"><h2><code>docker-compose.yml</code></h2></a>
<p>Weâ€™re almost ready to bring it up. Copy-paste the following <code>docker-compose.yml</code> file. Youâ€™ll need to ensure that it contains correct paths in the <code>volumes</code> sections.</p>
<p>The following configuration provides good defaults for Raspberry Pi. Pay attention:</p>
<ul>
<li><code>network_mode: 'host'</code> is needed for My IoT to talk to other devices.</li>
<li><code>image: tobi312/rpi-nginx</code> is needed specifically for Raspberry Pi. Use normal <code>image: nginx</code> otherwise.</li>
</ul>
<pre><code class="language-yaml">version: '3.7'
services:
  my-iot:
    container_name: my-iot
    image: eigenein/my-iot:latest
    restart: always
    network_mode: 'host'
    volumes:
    - './my-iot.sqlite3:/app/db.sqlite3'
    - './automation.py:/app/automation.py'
    environment:
      TZ: 'Europe/Amsterdam'
      MY_IOT_VERBOSITY: '2'
  nginx:
    container_name: nginx
    image: tobi312/rpi-nginx
    restart: always
    network_mode: 'host'
    volumes:
    - './nginx.conf:/etc/nginx/nginx.conf:ro'
    - './.htpasswd:/etc/nginx/.htpasswd:ro'
    - '/etc/letsencrypt/:/etc/letsencrypt/:ro'
</code></pre>
<p>And finally, just do:</p>
<pre><code class="language-bash">docker-compose up -d
</code></pre>
<a class="header" href="#recipes" id="recipes"><h1>Recipes</h1></a>
<a class="header" href="#monitor-your-raspberry-pi-cpu-temperature" id="monitor-your-raspberry-pi-cpu-temperature"><h2>Monitor your Raspberry Pi CPU temperature</h2></a>
<pre><code class="language-python">from datetime import timedelta
from pathlib import Path

from my_iot.services.file_ import FloatValueFile
from my_iot.types_ import Unit

SERVICES = [
    FloatValueFile(
        Path('/sys/class/thermal/thermal_zone0/temp'), 
        'cpu_temperature', 
        timedelta(seconds=5.0),
        Unit.CELSIUS,
        0.001,
        'CPU Temperature',
    ),
]
</code></pre>
<a class="header" href="#if-new-nest-cam-event-occurred-then-send-an-animation-to-telegram" id="if-new-nest-cam-event-occurred-then-send-an-animation-to-telegram"><h2>If new Nest Cam event occurred, then send an animation to Telegram</h2></a>
<pre><code class="language-python">TELEGRAM_TOKEN = ...
TELEGRAM_CHAT_ID = ...
NEST_STRUCTURE_ID = ...
AWAY_CHANNEL = f'nest:structure:{NEST_STRUCTURE_ID}:away'

from typing import Any

from aiohttp import ClientSession

from my_iot.actions.telegram import ParseMode, send_animation
from my_iot.routing import (
    router,
    if_actual_value_not_equal,
    if_channel_like,
    if_newer,
)
from my_iot.types_ import Event


@router
@if_channel_like(r'.*:last_animated_image_url')
@if_newer
@if_actual_value_not_equal(AWAY_CHANNEL, 'home')
async def on_away_camera_event(*, event: Event, session: ClientSession, **_: Any):
    await send_animation(
        session=session,
        token=TELEGRAM_TOKEN,
        chat_id=TELEGRAM_CHAT_ID,
        animation=event.value,
        disable_notification=True,
        caption=f'*{event.title}*\n{event.timestamp:%b %d, %H:%M:%S}',
        parse_mode=ParseMode.MARKDOWN,
    )
</code></pre>
<a class="header" href="#if-nest-detects-an-intrusion-then-send-a-message-to-telegram" id="if-nest-detects-an-intrusion-then-send-a-message-to-telegram"><h2>If Nest detects an intrusion, then send a message to Telegram</h2></a>
<pre><code class="language-python">TELEGRAM_TOKEN = ...
TELEGRAM_CHAT_ID = ...

from typing import Any

from aiohttp import ClientSession

from my_iot.actions.telegram import send_message
from my_iot.routing import (
    if_channel_like,
    if_changed,
    if_not_equal,
    router,
)


@router
@if_channel_like(r'.*:wwn_security_state')
@if_changed
@if_not_equal('ok')
async def on_deter(*, session: ClientSession, **_: Any):
    await send_message(
        session=session,
        token=TELEGRAM_TOKEN,
        chat_id=TELEGRAM_CHAT_ID,
        text='ðŸ”´ Intrusion detected',
    )
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        
        <!-- Google Analytics Tag -->
        <script type="text/javascript">
            var localAddrs = ["localhost", "127.0.0.1", ""];

            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-65034198-8', 'auto');
                ga('send', 'pageview');
            }
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
